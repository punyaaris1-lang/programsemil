<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN PUSAT - DOWNLOADER</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    body{font-family:'Segoe UI', sans-serif; background:#eef2f5; padding:20px; color:#444;}
    
    .navbar {
        background: #fff; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
    }
    .btn-pdf { background:#e74c3c; color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold; }

    .card {
        background: #fff; border-radius: 8px; overflow: hidden; margin-bottom: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #2980b9;
    }
    .header {
        background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
    }
    .body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* Bagian Biodata */
    .bio-section { padding-right: 20px; border-right: 1px dashed #ddd; }
    .row { margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; }
    .lbl { font-size: 11px; color: #888; font-weight: bold; display: block; }
    .val { font-size: 14px; color: #333; font-weight: 500; }

    /* Bagian Gallery Download */
    .file-section { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .file-box { text-align: center; border: 1px solid #eee; padding: 5px; border-radius: 5px; background: #fff; }
    .file-box img { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
    
    .btn-down {
        background: #27ae60; color: white; border: none; padding: 5px; width: 100%;
        border-radius: 3px; font-size: 10px; cursor: pointer; display: flex; 
        align-items: center; justify-content: center; gap: 5px;
    }
    .btn-down:hover { background: #219150; }

    @media (max-width: 768px) { .body { grid-template-columns: 1fr; } .bio-section { border-right: none; border-bottom: 1px dashed #ddd; padding-bottom: 20px; margin-bottom: 10px; } }
</style>
</head>
<body>

<div class="navbar">
    <b>PANEL ADMIN PUSAT</b>
    <span style="font-size:12px">Total: <span id="total">0</span> Driver</span>
</div>

<div id="container">Loading data...</div>

<script>
// CONFIG (SAMA SEPERTI FORMULIR)
const firebaseConfig = {
  apiKey: "AIzaSyD-4D5ZC4RYcmcpRyxxScLBo1oqC-oRdYw",
  authDomain: "sewamilikmolis-e3427.firebaseapp.com",
  projectId: "sewamilikmolis-e3427",
  storageBucket: "sewamilikmolis-e3427.firebasestorage.app",
  messagingSenderId: "934998664118",
  appId: "1:934998664118:web:602d8ef8053099aa329717"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// RENDER DATA
db.collection("pendaftaran_hemat").orderBy("waktu", "desc").onSnapshot(snap => {
    const div = document.getElementById('container');
    document.getElementById('total').innerText = snap.size;
    div.innerHTML = "";

    if(snap.empty) { div.innerHTML = "<center>Data kosong.</center>"; return; }

    snap.forEach(doc => {
        const d = doc.data();
        const safeName = d.nama.replace(/\s+/g, '_'); // Nama untuk file

        div.innerHTML += `
        <div class="card">
            <div class="header">
                <div>
                    <b style="font-size:16px">${d.nama.toUpperCase()}</b>
                    <div style="font-size:11px; color:#777">${d.waktu}</div>
                </div>
                <div style="text-align:right">
                    <small>Ref: <b>${d.referral}</b></small>
                </div>
            </div>
            
            <div class="body">
                <div class="bio-section">
                    <div class="row"><span class="lbl">WhatsApp</span><span class="val">${d.wa}</span></div>
                    <div class="row"><span class="lbl">TTL</span><span class="val">${d.ttl}</span></div>
                    <div class="row"><span class="lbl">Status</span><span class="val">${d.status}</span></div>
                    <div class="row"><span class="lbl">Domisili</span><span class="val">${d.alamatDomisili}</span></div>
                    <div class="row"><span class="lbl">Kontak Darurat</span><span class="val">${d.darurat}</span></div>
                    <div class="row"><span class="lbl">Lokasi Maps</span><a href="${d.maps}" target="_blank" style="font-size:12px">Buka Maps ↗</a></div>
                </div>

                <div>
                    <span class="lbl" style="margin-bottom:10px">FILE DOKUMEN (KLIK TOMBOL HIJAU UNTUK DOWNLOAD)</span>
                    <div class="file-section">
                        ${renderDownloader(d.ktp, 'KTP', safeName)}
                        ${renderDownloader(d.sim, 'SIM', safeName)}
                        ${renderDownloader(d.kk, 'KK', safeName)}
                        ${renderDownloader(d.selfie, 'SELFIE', safeName)}
                        ${renderDownloader(d.ojol, 'PROFIL', safeName)}
                        ${renderDownloader(d.gaji1, 'GAJI_1', safeName)}
                    </div>
                </div>
            </div>
        </div>`;
    });
});

// FUNGSI RENDER TOMBOL DOWNLOAD
function renderDownloader(base64, jenis, namaUser){
    if(!base64) return "";
    
    // Kita buat tombol yang memanggil fungsi download
    return `
    <div class="file-box">
        <img src="${base64}">
        <button class="btn-down" onclick="downloadImg('${base64}', '${namaUser}_${jenis}.jpg')">
            ⬇️ SIMPAN
        </button>
    </div>`;
}

// FUNGSI DOWNLOAD OTOMATIS
function downloadImg(dataUrl, filename) {
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

</body>
</html>
