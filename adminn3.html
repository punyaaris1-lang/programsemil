<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Semil Alfa N3</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; padding: 20px; background: #f0f2f5; margin: 0; }
        
        /* HEADER DASHBOARD */
        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; color: #d32f2f; font-size: 24px; }
        
        /* TABLE STYLES */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        thead { background: #d32f2f; color: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: top; }
        tr:hover { background: #fafafa; }
        
        /* BUTTONS */
        .btn-action {
            display: inline-block; padding: 6px 12px; margin-top: 5px;
            background: #333; color: white; border: none; border-radius: 4px;
            font-size: 12px; cursor: pointer; text-decoration: none;
        }
        .btn-action:hover { background: #000; }
        .btn-wa { background: #25D366; color: white; text-decoration: none; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; display: inline-block; margin-top: 5px;}
        
        .user-info strong { display: block; color: #333; font-size: 14px; }
        .user-info span { color: #666; font-size: 12px; }

        /* PRINT STYLES (Hanya muncul pas nge-print) */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; }
            @page { size: A4; margin: 10mm; }
        }

        /* AREA PRINT TERSEMBUNYI (Template PDF) */
        #printArea { display: none; }
        .print-header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .print-title { font-size: 24px; font-weight: bold; margin: 0; }
        .print-subtitle { font-size: 14px; }
        .print-section { margin-top: 20px; margin-bottom: 10px; font-weight: bold; background: #eee; padding: 5px; border-bottom: 1px solid #000; }
        .print-row { display: flex; margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .print-label { width: 180px; font-weight: bold; }
        .print-value { flex: 1; }
        
        .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .print-img-box { text-align: center; border: 1px solid #ccc; padding: 5px; break-inside: avoid; }
        .print-img-box img { max-width: 100%; max-height: 250px; object-fit: contain; }
        .print-img-label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; background: #ddd; }

    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>ADMIN - SEMIL ALFA N3</h1>
            <span style="font-size:12px; color:#666;">Data Realtime gadingfc22</span>
        </div>
        <div id="totalCount" style="font-weight:bold;">Total: 0</div>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Tgl Daftar</th>
                    <th>Ref</th>
                    <th>Nama & Kontak</th>
                    <th>Status & Alamat</th>
                    <th>Aksi Admin</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" style="text-align:center; padding:20px;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="printArea">
        </div>

<script>
    // --- DATABASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
      authDomain: "rtomaka-e67b5.firebaseapp.com",
      projectId: "rtomaka-e67b5",
      storageBucket: "rtomaka-e67b5.firebasestorage.app",
      messagingSenderId: "472036722228",
      appId: "1:472036722228:web:11d520f9204db317d02c61"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global Variable buat nyimpen data sementara
    window.dbData = {}; 

    const tbody = document.getElementById('tableBody');
    const totalCount = document.getElementById('totalCount');

    // 1. TARIK DATA DARI FIREBASE
    db.collection("gadingfc22").orderBy("submittedAt", "desc").onSnapshot((snapshot) => {
        tbody.innerHTML = "";
        totalCount.innerText = `Total: ${snapshot.size} Pendaftar`;

        if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Belum ada data.</td></tr>";
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            const id = doc.id;
            
            // Simpan ke variabel global biar bisa dipanggil fungsi print
            window.dbData[id] = data;

            // Format Tanggal
            let tanggal = "-";
            if (data.submittedAt) {
                tanggal = data.submittedAt.toDate().toLocaleString('id-ID');
            }

            // Link WA
            const waLink = `https://wa.me/62${data.wa.replace(/^0/, '')}`;

            const row = `
                <tr>
                    <td>${tanggal}</td>
                    <td style="color:red; font-weight:bold;">${data.referral}</td>
                    <td class="user-info">
                        <strong>${data.nama}</strong>
                        <span>Email: ${data.email}</span><br>
                        <span>WA: ${data.wa}</span><br>
                        <a href="${waLink}" target="_blank" class="btn-wa">Chat WA</a>
                    </td>
                    <td class="user-info">
                        <strong>${data.statusNikah}</strong>
                        <span>Domisili: ${data.alamatDomisili}</span>
                    </td>
                    <td>
                        <button class="btn-action" onclick="printPendaftar('${id}')">üñ®Ô∏è Cetak PDF</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    });

    // 2. FUNGSI CETAK PDF (GENERATE TAMPILAN SURAT)
    function printPendaftar(id) {
        const d = window.dbData[id];
        if(!d) return alert("Data tidak ditemukan!");

        const printArea = document.getElementById('printArea');
        
        // Buat Template Surat
        let html = `
            <div class="print-header">
                <div class="print-title">FORMULIR REGISTRASI SEMIL ALFA N3</div>
                <div class="print-subtitle">Database Ref: gadingfc22 | Referral: <strong>${d.referral}</strong></div>
            </div>

            <div class="print-section">A. DATA PRIBADI</div>
            <div class="print-row"><div class="print-label">Nama Lengkap</div><div class="print-value">: ${d.nama}</div></div>
            <div class="print-row"><div class="print-label">Email</div><div class="print-value">: ${d.email}</div></div>
            <div class="print-row"><div class="print-label">Nomor WhatsApp</div><div class="print-value">: ${d.wa}</div></div>
            <div class="print-row"><div class="print-label">Tempat/Tgl Lahir</div><div class="print-value">: ${d.ttl}</div></div>
            <div class="print-row"><div class="print-label">Status Pernikahan</div><div class="print-value">: ${d.statusNikah}</div></div>
            
            <div class="print-section">B. ALAMAT & KONTAK DARURAT</div>
            <div class="print-row"><div class="print-label">Alamat KTP</div><div class="print-value">: ${d.alamatKtp}</div></div>
            <div class="print-row"><div class="print-label">Alamat Domisili</div><div class="print-value">: ${d.alamatDomisili}</div></div>
            <div class="print-row"><div class="print-label">Kontak Darurat</div><div class="print-value">: ${d.emergencyName} (${d.emergencyPhone})</div></div>
            <div class="print-row"><div class="print-label">Lokasi Rumah (Maps)</div><div class="print-value">: ${d.locationLink}</div></div>

            <div class="print-section">C. LAMPIRAN DOKUMEN</div>
            <div class="print-grid">
        `;

        // Helper untuk tambah gambar
        const addImg = (label, url) => {
            if(url) {
                html += `
                    <div class="print-img-box">
                        <span class="print-img-label">${label}</span>
                        <img src="${url}" crossorigin="anonymous">
                    </div>
                `;
            }
        };

        addImg("KTP Asli", d.ktp_url);
        addImg("KTP Pasangan", d.ktp_pasangan_url);
        addImg("SIM C", d.sim_url);
        addImg("Kartu Keluarga", d.kk_url);
        addImg("Surat Domisili", d.domisili_url);
        addImg("Foto Selfie", d.selfie_url);
        addImg("Profil Ojol", d.ojol_profile_url);
        addImg("Bukti Pendapatan 1", d.pendapatan1_url);
        addImg("Bukti Pendapatan 2", d.pendapatan2_url);
        addImg("Bukti Pendapatan 3", d.pendapatan3_url);

        html += `</div>`; // Tutup Grid

        // Masukkan ke area print
        printArea.innerHTML = html;
        printArea.style.display = 'block'; // Munculkan sebentar untuk dibaca browser

        // Trigger Print
        setTimeout(() => {
            window.print();
            printArea.style.display = 'none'; // Sembunyikan lagi setelah dialog print muncul
        }, 500); // Delay 0.5 detik biar gambar sempat load dikit
    }
</script>

</body>
</html>
