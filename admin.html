<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin 1 - Verifikasi</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0056b3; --bg: #f5f7fa; --success: #28a745; --danger: #dc3545; --dark: #343a40; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Navbar / Header */
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-left: 5px solid var(--primary); }
        .header h1 { margin: 0; font-size: 20px; color: var(--dark); text-transform: uppercase; }
        .badge-count { background: var(--danger); color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* Tabel Data */
        .table-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background: #f1f8ff; }
        
        .btn-lihat { background: var(--primary); color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-lihat:hover { background: #004494; }

        /* Modal (Pop-up Detail) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; width: 100%; max-width: 900px; height: 90vh; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .modal-header { padding: 15px 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 18px; }
        .btn-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

        .modal-body { padding: 20px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .modal-body { grid-template-columns: 1fr; } }
        
        /* Box Info Text */
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .info-title { font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 3px; }
        .info-value { font-size: 14px; color: #333; font-weight: 600; margin-bottom: 10px; }

        /* Box Foto */
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .photo-card { border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: center; }
        .photo-card img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; border: 1px solid #eee; }
        .photo-card a { display: block; background: #e9ecef; color: #333; text-decoration: none; font-size: 11px; padding: 5px; border-radius: 4px; font-weight: bold; }
        .photo-card a:hover { background: #dde2e6; }

        /* Modal Footer (Action Buttons) */
        .modal-footer { padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-acc { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-tolak { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
        
        #loadingMsg { text-align: center; padding: 50px; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Dashboard Admin 1 - Pendaftar Baru</h1>
        <div class="badge-count" id="countBadge">0 Antrian</div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Tanggal Masuk</th>
                    <th>Nama Pemohon</th>
                    <th>Tipe Motor</th>
                    <th>No WA</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" id="loadingMsg">Memuat data dari server...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalNama">Detail Pemohon</h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div>
                    <h3 style="margin-top:0; color:var(--primary); font-size:16px; border-bottom:2px solid #eee; padding-bottom:5px;">Biodata & Pekerjaan</h3>
                    
                    <div class="info-box">
                        <div class="info-title">Pilihan Kendaraan</div>
                        <div class="info-value" id="md_motor">-</div>
                        
                        <div class="info-title">Kode Referral</div>
                        <div class="info-value" id="md_ref">-</div>
                        
                        <div class="info-title">NIK</div>
                        <div class="info-value" id="md_nik">-</div>
                        
                        <div class="info-title">Nomor WhatsApp</div>
                        <div class="info-value" id="md_wa">-</div>
                        
                        <div class="info-title">Tempat, Tanggal Lahir</div>
                        <div class="info-value" id="md_ttl">-</div>
                        
                        <div class="info-title">Alamat KTP</div>
                        <div class="info-value" id="md_alamatKtp">-</div>
                        
                        <div class="info-title">Aplikasi Ojol</div>
                        <div class="info-value" style="color:var(--primary);" id="md_aplikasi">-</div>
                    </div>

                    <h3 style="color:var(--primary); font-size:16px; border-bottom:2px solid #eee; padding-bottom:5px;">Data Penjamin</h3>
                    <div class="info-box">
                        <div class="info-title">Nama Penjamin</div>
                        <div class="info-value" id="md_pjNama">-</div>
                        <div class="info-title">Hubungan</div>
                        <div class="info-value" id="md_pjHub">-</div>
                        <div class="info-title">No WA Penjamin</div>
                        <div class="info-value" id="md_pjWa">-</div>
                    </div>
                </div>

                <div>
                    <h3 style="margin-top:0; color:var(--primary); font-size:16px; border-bottom:2px solid #eee; padding-bottom:5px;">Dokumen Pendukung</h3>
                    <div class="photo-grid" id="photoContainer">
                        </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-tolak" onclick="tolakData()">TOLAK / REVISI</button>
                <button class="btn-acc" onclick="accData()">âœ… DATA VALID - TERUSKAN KE KANTOR</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE FIRESTORE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
      authDomain: "rtomaka-e67b5.firebaseapp.com",
      projectId: "rtomaka-e67b5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let allData = []; // Simpan data sementara
    let currentId = ""; // ID dokumen yg sedang dibuka di modal

    // MENGAMBIL DATA DARI FIREBASE (YANG STATUSNYA 1)
    function loadData() {
        db.collection("gadingfc22")
          .where("status_pengajuan", "==", "1_Menunggu_Admin")
          .orderBy("submittedAt", "desc")
          .onSnapshot((querySnapshot) => {
              const tbody = document.getElementById("tableBody");
              const badge = document.getElementById("countBadge");
              
              allData = [];
              tbody.innerHTML = "";
              badge.innerText = `${querySnapshot.size} Antrian`;

              if(querySnapshot.empty) {
                  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Tidak ada pengajuan baru.</td></tr>`;
                  return;
              }

              querySnapshot.forEach((doc) => {
                  let d = doc.data();
                  d.id = doc.id; // Simpan ID unik Firebase
                  allData.push(d);

                  // Format Tanggal
                  let tgl = d.submittedAt ? d.submittedAt.toDate().toLocaleString('id-ID') : "Baru saja";

                  tbody.innerHTML += `
                      <tr>
                          <td>${tgl}</td>
                          <td style="font-weight:bold;">${d.nama}</td>
                          <td><span style="background:#e9ecef; padding:3px 8px; border-radius:4px; font-size:12px;">${d.motor_pilihan}</span></td>
                          <td>${d.wa}</td>
                          <td><button class="btn-lihat" onclick="bukaModal('${d.id}')">Lihat Detail</button></td>
                      </tr>
                  `;
              });
          });
    }

    // BUKA POP-UP DETAIL
    function bukaModal(id) {
        currentId = id;
        const data = allData.find(item => item.id === id);
        
        if(!data) return;

        // 1. Isi Data Teks
        document.getElementById("modalNama").innerText = `Detail: ${data.nama}`;
        document.getElementById("md_motor").innerText = data.motor_pilihan || "-";
        document.getElementById("md_ref").innerText = data.referral || "-";
        document.getElementById("md_nik").innerText = data.nik || "-";
        document.getElementById("md_wa").innerHTML = `<a href="https://wa.me/62${data.wa.substring(1)}" target="_blank">${data.wa}</a>`;
        document.getElementById("md_ttl").innerText = data.ttl || "-";
        document.getElementById("md_alamatKtp").innerText = data.alamatKtp || "-";
        document.getElementById("md_aplikasi").innerText = data.aplikasi_ojol || "-";
        
        document.getElementById("md_pjNama").innerText = data.penjamin_nama || "-";
        document.getElementById("md_pjHub").innerText = data.penjamin_hubungan || "-";
        document.getElementById("md_pjWa").innerText = data.penjamin_wa || "-";

        // 2. Isi Data Foto Dinamis (Yang ada aja yg dimunculin)
        const photoKeys = [
            {key: 'selfie_url', label: 'Foto Selfie'},
            {key: 'ktp_url', label: 'KTP Asli'},
            {key: 'sim_url', label: 'SIM C'},
            {key: 'kk_url', label: 'Kartu Keluarga'},
            {key: 'ojol_profile_url', label: 'Profil Ojol'},
            {key: 'token_listrik_url', label: 'Token Listrik'},
            {key: 'ktp_penjamin_url', label: 'KTP Penjamin'},
            {key: 'foto_rumah_url', label: 'Rumah Depan'},
            {key: 'pendapatan1_url', label: 'Gaji Bln 1'},
            {key: 'pendapatan2_url', label: 'Gaji Bln 2'},
            {key: 'pendapatan3_url', label: 'Gaji Bln 3'},
            {key: 'pendapatan4_url', label: 'Gaji Bln 4'},
            {key: 'pendapatan5_url', label: 'Gaji Bln 5'},
            {key: 'pendapatan6_url', label: 'Gaji Bln 6'},
            {key: 'pendapatan7_url', label: 'Gaji Bln 7'},
            {key: 'pendapatan8_url', label: 'Gaji Bln 8'},
            {key: 'domisili_url', label: 'Surat Domisili'}
        ];

        const pContainer = document.getElementById("photoContainer");
        pContainer.innerHTML = ""; // Bersihkan dulu

        photoKeys.forEach(p => {
            if (data[p.key]) { // Kalau URL fotonya ada di database
                pContainer.innerHTML += `
                    <div class="photo-card">
                        <span style="font-size:11px; font-weight:bold; display:block; margin-bottom:5px;">${p.label}</span>
                        <img src="${data[p.key]}" alt="${p.label}">
                        <a href="${data[p.key]}" target="_blank" download>Buka / Download</a>
                    </div>
                `;
            }
        });

        // Tampilkan Modal
        document.getElementById("detailModal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("detailModal").style.display = "none";
        currentId = "";
    }

    // --- FUNGSI EKSEKUSI (UBAH STATUS) ---

    // 1. DITERUSKAN KE KANTOR PUSAT
    function accData() {
        if(!currentId) return;
        const confirmMsg = confirm("Apakah Anda yakin data ini sudah LENGKAP & VALID untuk diteruskan ke Kantor Pusat?");
        
        if(confirmMsg) {
            db.collection("gadingfc22").doc(currentId).update({
                status_pengajuan: "2_Dicek_Kantor",
                waktu_acc_admin: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Berhasil! Data telah dipindahkan ke meja Kantor Pusat.");
                closeModal();
            }).catch(error => alert("Gagal: " + error.message));
        }
    }

    // 2. DITOLAK / REVISI
    function tolakData() {
        if(!currentId) return;
        const alasan = prompt("Masukkan alasan penolakan/revisi (Contoh: KTP buram, KK kurang jelas):");
        
        if(alasan !== null && alasan !== "") {
            db.collection("gadingfc22").doc(currentId).update({
                status_pengajuan: "Ditolak_Admin1",
                alasan_tolak: alasan
            }).then(() => {
                alert("Data berhasil ditolak/dikembalikan.");
                closeModal();
            }).catch(error => alert("Gagal: " + error.message));
        }
    }

    // Jalankan load data saat web dibuka
    window.onload = loadData;
</script>

</body>
</html>
