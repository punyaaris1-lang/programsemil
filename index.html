<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registrasi Semil Alfa N3</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root { --primary:#2c3e50; --bg:#ecf0f1; --success:#27ae60; --bar:#2980b9 }
body{font-family:Poppins;background:var(--bg);margin:0;padding:20px}
.container{max-width:700px;margin:auto;background:#fff;padding:20px;border-radius:12px;border-top:5px solid var(--primary)}
.header h1{text-align:center;color:var(--primary);font-size:22px}
.form-group{margin-bottom:15px}
label{font-size:13px;font-weight:500}
input,textarea,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:5px}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.upload-card{border:1px solid #ddd;border-radius:8px;padding:10px;position:relative}
.preview-img{width:100%;height:80px;object-fit:cover;display:none;margin-top:5px}
.progress-wrapper{height:6px;background:#eee;border-radius:3px;margin-top:5px;display:none}
.progress-fill{height:100%;width:0%;background:var(--bar)}
.status-text{font-size:10px;font-weight:bold}
.badge-ok{position:absolute;top:5px;right:5px;background:var(--success);color:#fff;font-size:9px;padding:2px 6px;display:none}
.btn-submit{background:var(--primary);color:#fff;padding:15px;width:100%;border:none;border-radius:6px;font-size:16px;font-weight:bold}
.btn-submit:disabled{background:#aaa}
#totalProgress{display:none;margin-top:15px;text-align:center;font-weight:bold}
</style>
</head>

<body>
<div class="container">
<div class="header"><h1>FORMULIR ALFA N3</h1></div>

<form id="alfaForm">
<div class="form-group"><label>Referral</label><input id="referral" value="Apri" readonly></div>

<div class="form-group"><label>Nama Lengkap</label><input id="nama" required></div>
<div class="form-group"><label>No WhatsApp</label><input id="wa" required></div>
<div class="form-group"><label>Tempat, Tgl Lahir</label><input id="ttl" required></div>
<div class="form-group"><label>Status</label>
<select id="statusNikah" required>
<option value="">-- Pilih --</option>
<option>Belum Menikah</option>
<option>Menikah</option>
<option>Cerai</option>
</select>
</div>

<div class="form-group"><label>Alamat KTP</label><textarea id="alamatKtp" required></textarea></div>
<div class="form-group"><label>Alamat Domisili</label>
<input type="checkbox" id="checkSama" onchange="copyAlamat()"> Sama dgn KTP
<textarea id="alamatDomisili" required></textarea>
</div>

<div class="form-group"><label>Email</label><input id="email" type="email" required></div>
<div class="form-group"><label>Nama Kontak Darurat</label><input id="emergencyName" required></div>
<div class="form-group"><label>No HP Darurat</label><input id="emergencyPhone" required></div>
<div class="form-group"><label>Shareloc</label><textarea id="locationLink"></textarea></div>

<div class="upload-grid" id="uploadContainer"></div>

<div id="totalProgress"></div>
<button class="btn-submit" id="btnKirim">KIRIM DATA</button>
</form>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
 apiKey:"AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
 authDomain:"rtomaka-e67b5.firebaseapp.com",
 projectId:"rtomaka-e67b5",
 storageBucket:"rtomaka-e67b5.appspot.com",
 messagingSenderId:"472036722228",
 appId:"1:472036722228:web:11d520f9204db317d02c61"
});

const db=firebase.firestore();
const storage=firebase.storage();

/* ================= FILE LIST ================= */
const docs=[
{id:'ktp',label:'KTP',r:true},
{id:'ktp_pasangan',label:'KTP Pasangan',r:true},
{id:'sim',label:'SIM',r:true},
{id:'domisili',label:'Surat Domisili',r:false},
{id:'kk',label:'KK',r:true},
{id:'selfie',label:'Selfie',r:true},
{id:'ojol_profile',label:'Profil Ojol',r:true},
{id:'pendapatan1',label:'Gaji 1',r:true},
{id:'pendapatan2',label:'Gaji 2',r:true},
{id:'pendapatan3',label:'Gaji 3',r:true}
];

const c=document.getElementById("uploadContainer");
docs.forEach(d=>{
 c.innerHTML+=`
 <div class="upload-card">
 <span class="badge-ok" id="ok_${d.id}">OK</span>
 <b>${d.label}</b>
 <input type="file" id="${d.id}" ${d.r?'required':''} accept="image/*"
 onchange="preview(this,'img_${d.id}')">
 <img id="img_${d.id}" class="preview-img">
 <div class="progress-wrapper" id="wrap_${d.id}">
 <div class="progress-fill" id="fill_${d.id}"></div>
 </div>
 <div class="status-text" id="stat_${d.id}"></div>
 </div>`;
});

function preview(i,id){
 const f=i.files[0];
 if(!f)return;
 const img=document.getElementById(id);
 img.src=URL.createObjectURL(f);
 img.style.display="block";
}

function copyAlamat(){
 if(checkSama.checked){
  alamatDomisili.value=alamatKtp.value;
  alamatDomisili.readOnly=true;
 } else {
  alamatDomisili.value="";
  alamatDomisili.readOnly=false;
 }
}

/* ================= KOMPRESI FIX ================= */
function compressImage(file){
 return new Promise(res=>{
  if(!file.type.match(/image/)) return res(file);
  const img=new Image();
  img.src=URL.createObjectURL(file);
  img.onload=()=>{
   const c=document.createElement("canvas");
   const max=800;
   let w=img.width,h=img.height;
   if(w>h&&w>max){h*=max/w;w=max}
   else if(h>max){w*=max/h;h=max}
   c.width=w;c.height=h;
   c.getContext("2d").drawImage(img,0,0,w,h);
   c.toBlob(b=>{
    if(!b)return res(file);
    res(new File([b],file.name,{type:"image/jpeg"}));
   },"image/jpeg",0.7);
  };
 });
}

/* ================= SUBMIT ================= */
alfaForm.onsubmit=async e=>{
 e.preventDefault();
 btnKirim.disabled=true;
 totalProgress.style.display="block";
 totalProgress.innerText="Uploading...";

 const safeName=nama.value.replace(/\s+/g,"_");
 let urls={};

 for(let d of docs){
  const f=document.getElementById(d.id).files[0];
  if(!f) continue;
  const file=await compressImage(f);

  const ref=storage.ref(`gadingfc22/${referral.value}_${safeName}_${d.id}.jpg`);
  document.getElementById(`wrap_${d.id}`).style.display="block";

  await new Promise((ok,fail)=>{
   ref.put(file,{contentType:"image/jpeg"}).on("state_changed",s=>{
    const p=(s.bytesTransferred/s.totalBytes)*100;
    document.getElementById(`fill_${d.id}`).style.width=p+"%";
    document.getElementById(`stat_${d.id}`).innerText=Math.floor(p)+"%";
   },fail,async()=>{
    urls[d.id]=await ref.getDownloadURL();
    document.getElementById(`ok_${d.id}`).style.display="block";
    ok();
   });
  });
 }

 await db.collection("gadingfc22").add({
  referral:referral.value,
  nama:nama.value,
  wa:wa.value,
  ttl:ttl.value,
  statusNikah:statusNikah.value,
  alamatKtp:alamatKtp.value,
  alamatDomisili:alamatDomisili.value,
  email:email.value,
  emergencyName:emergencyName.value,
  emergencyPhone:emergencyPhone.value,
  locationLink:locationLink.value,
  created:firebase.firestore.FieldValue.serverTimestamp(),
  ...urls
 });

 alert("SUKSES");
 location.reload();
};
</script>
</body>
</html>
