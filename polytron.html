<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulir Polytron Fox 350</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* TEMA POLYTRON */
:root {
    --primary: #d90429; 
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #0f172a;
    --border: #e2e8f0;
}

body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    margin: 0; padding: 20px;
    color: var(--text);
}

.container {
    max-width: 550px; margin: 0 auto;
    background: var(--card);
    padding: 30px; border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border-top: 6px solid var(--primary);
}

.header { text-align: center; margin-bottom: 30px; }
.header h2 { margin: 0; font-size: 26px; font-weight: 800; color: #1e293b; letter-spacing: -0.5px; }
.badge { 
    background: #d90429; color: white; padding: 5px 15px; 
    border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; margin-top: 10px;
}

.section-label {
    font-size: 11px; font-weight: 800; text-transform: uppercase;
    color: var(--primary); letter-spacing: 1px;
    margin: 30px 0 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px;
}

.form-group { margin-bottom: 15px; }
label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #334155; }

input, select, textarea {
    width: 100%; padding: 14px;
    border: 1px solid var(--border); border-radius: 10px;
    font-size: 14px; box-sizing: border-box; font-family: inherit;
    transition: 0.2s; background: #f8fafc;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; }

/* UPLOAD AREA */
.upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.upload-box {
    border: 1px dashed #cbd5e1; background: #fff;
    border-radius: 10px; padding: 20px 10px; text-align: center;
    position: relative; transition: 0.2s;
}
.upload-box:hover { border-color: var(--primary); background: #fff5f5; }
.upload-box input {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0; cursor: pointer;
}
.icon { font-size: 24px; display: block; margin-bottom: 8px; }
.lbl-up { font-size: 11px; font-weight: 700; display: block; color: #334155; }
.note-up { font-size: 9px; color: #ef4444; font-weight: 800; display: block; margin-top: 4px; }
.preview {
    width: 100%; height: 90px; object-fit: cover; border-radius: 8px;
    display: none; margin-top: 10px; border: 1px solid #e2e8f0;
}

/* MULTI UPLOAD */
.multi-box { background: #fff5f5; padding: 20px; border-radius: 12px; border: 1px dashed #fb7185; }
.multi-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
.thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #fecdd3; }

.btn {
    width: 100%; padding: 18px; background: var(--primary);
    color: white; border: none; border-radius: 12px;
    font-size: 16px; font-weight: 800; cursor: pointer;
    margin-top: 30px; transition: 0.2s;
}
.btn:hover { background: #b90323; }
.btn:disabled { background: #cbd5e1; cursor: not-allowed; }

#loading { display: none; text-align: center; margin-top: 20px; font-size: 13px; color: #d90429; font-weight: 700; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>SEWA MILIK</h2>
        <div class="badge">POLYTRON FOX 350</div>
    </div>

    <form id="formPolytron">
        <div class="section-label">1. DATA PRIBADI</div>
        
        <div class="form-group">
            <label>Nama Lengkap (Sesuai KTP)</label>
            <input type="text" id="nama" required placeholder="Nama Lengkap">
        </div>
        <div class="form-group">
            <label>Nomor WhatsApp</label>
            <input type="tel" id="wa" required placeholder="08xxxxxxxxxx">
        </div>
        <div class="form-group">
            <label>Alamat Email</label>
            <input type="email" id="email" required placeholder="email@contoh.com">
        </div>
        <div class="form-group">
            <label>Domisili Saat Ini</label>
            <textarea id="alamat" rows="2" placeholder="Alamat Lengkap..." required></textarea>
        </div>
        <div class="form-group">
            <label>Pekerjaan</label>
            <select id="pekerjaan" required>
                <option value="">-- Pilih Pekerjaan --</option>
                <option value="Ojol">Ojek Online</option>
                <option value="Kurir">Kurir Ekspedisi</option>
                <option value="Wiraswasta">Wiraswasta</option>
                <option value="Karyawan">Karyawan Swasta</option>
                <option value="Lainnya">Lainnya</option>
            </select>
        </div>

        <div class="section-label">2. DOKUMEN PERSYARATAN</div>

        <div class="upload-grid">
            <div class="upload-box">
                <span class="icon">ðŸªª</span><span class="lbl-up">KTP ASLI</span>
                <input type="file" id="ktp" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_ktp">
            </div>
            <div class="upload-box">
                <span class="icon">ðŸ“„</span><span class="lbl-up">KARTU KELUARGA</span>
                <input type="file" id="kk" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_kk">
            </div>
            <div class="upload-box">
                <span class="icon">ðŸ’³</span><span class="lbl-up">SIM C</span>
                <input type="file" id="sim" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_sim">
            </div>
            <div class="upload-box" style="border-color:#d90429; background:#fff1f2">
                <span class="icon">ðŸ‘¥</span><span class="lbl-up" style="color:#d90429">KTP PENJAMIN</span>
                <span class="note-up">(WAJIB 1 KK)</span>
                <input type="file" id="penjamin" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_penjamin">
            </div>
            <div class="upload-box">
                <span class="icon">âš¡</span><span class="lbl-up">DOMISILI / LISTRIK</span>
                <input type="file" id="domisili" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_domisili">
            </div>
            <div class="upload-box">
                <span class="icon">ðŸ“±</span><span class="lbl-up">PROFIL OJOL</span>
                <input type="file" id="profil" accept="image/*" required onchange="prev(this)">
                <img class="preview" id="show_profil">
            </div>
        </div>

        <div class="section-label">3. BUKTI PENDAPATAN</div>
        <div class="multi-box">
            <label style="color:#9f1239">Pendapatan 3 Bulan Terakhir</label>
            <input type="file" id="gajiInput" multiple accept="image/*" style="width:100%; background:white">
            <div class="multi-preview" id="gajiBox"></div>
        </div>

        <div id="loading">Sedang memproses data...</div>
        <button type="submit" class="btn" id="btnKirim">AJUKAN SEKARANG</button>
    </form>
    
    <a href="index.html" style="display:block; text-align:center; margin-top:20px; font-size:12px; color:#64748b; text-decoration:none">Kembali ke Menu</a>
</div>

<script>
// --- 1. CONFIG FIREBASE (DATABASE) ---
const firebaseConfig = {
  apiKey: "AIzaSyD-4D5ZC4RYcmcpRyxxScLBo1oqC-oRdYw",
  authDomain: "sewamilikmolis-e3427.firebaseapp.com",
  projectId: "sewamilikmolis-e3427",
  storageBucket: "sewamilikmolis-e3427.firebasestorage.app",
  messagingSenderId: "934998664118",
  appId: "1:934998664118:web:602d8ef8053099aa329717"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- 2. CONFIG TELEGRAM (NOTIFIKASI) ---
const BOT_TOKEN = "8235411301:AAE9bUwgg4eYS1M_e5_F30SAmNPgPs5zlF0";
const CHAT_ID = "1902240448";
const UNIT_NAME = "POLYTRON FOX 350";

// --- FUNGSI PENDUKUNG ---
function prev(input) {
    if(input.files && input.files[0]) {
        document.getElementById('show_' + input.id).src = URL.createObjectURL(input.files[0]);
        document.getElementById('show_' + input.id).style.display = "block";
    }
}

let gajiFiles = [];
document.getElementById('gajiInput').addEventListener('change', function(e) {
    const box = document.getElementById('gajiBox');
    box.innerHTML = ""; 
    gajiFiles = Array.from(e.target.files).slice(0,15);
    gajiFiles.forEach(f => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        img.className = "thumb";
        box.appendChild(img);
    });
});

function compress(file) {
    return new Promise(resolve => {
        if(!file) resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                let w=img.width, h=img.height, max=500;
                if(w>h && w>max) { h*=max/w; w=max; } else if(h>max) { w*=max/h; h=max; }
                cvs.width = w; cvs.height = h;
                cvs.getContext('2d').drawImage(img,0,0,w,h);
                resolve(cvs.toDataURL('image/jpeg', 0.6));
            };
        };
    });
}

// --- SUBMIT: SIMPAN FIREBASE + KIRIM TELEGRAM ---
document.getElementById('formPolytron').addEventListener('submit', async (e) => {
    e.preventDefault();
    if(gajiFiles.length === 0) { alert("Upload bukti pendapatan!"); return; }

    const btn = document.getElementById('btnKirim');
    const load = document.getElementById('loading');
    btn.disabled = true; 
    load.style.display = "block";

    try {
        load.innerText = "1/3 Mengkompres Data...";
        
        // Kompres Gambar untuk Firebase
        const ids = ['ktp','kk','sim','penjamin','domisili','profil'];
        let base64Imgs = {};
        for(let id of ids) base64Imgs[id] = await compress(document.getElementById(id).files[0]);
        
        let base64Gaji = [];
        for(let f of gajiFiles) base64Gaji.push(await compress(f));

        // A. SIMPAN KE FIREBASE
        load.innerText = "2/3 Menyimpan ke Database...";
        await db.collection("pendaftaran_v3").add({
            unit: UNIT_NAME,
            nama: document.getElementById('nama').value,
            wa: document.getElementById('wa').value,
            email: document.getElementById('email').value,
            alamat: document.getElementById('alamat').value,
            pekerjaan: document.getElementById('pekerjaan').value,
            
            // Gambar Base64 (Untuk Database)
            foto_ktp: base64Imgs['ktp'],
            foto_kk: base64Imgs['kk'],
            foto_sim: base64Imgs['sim'],
            foto_penjamin: base64Imgs['penjamin'],
            foto_domisili: base64Imgs['domisili'],
            foto_profil: base64Imgs['profil'],
            list_gaji: base64Gaji,
            
            waktu: new Date().toLocaleString(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // B. KIRIM NOTIFIKASI TELEGRAM
        load.innerText = "3/3 Mengirim Notifikasi Admin...";
        
        // Kirim Teks
        let pesan = `ðŸ”¥ *ORDER BARU: ${UNIT_NAME}* ðŸ”¥\n` +
                    `ðŸ‘¤ ${document.getElementById('nama').value}\n` +
                    `ðŸ“± ${document.getElementById('wa').value}\n` +
                    `ðŸ  ${document.getElementById('alamat').value}\n` +
                    `_Data lengkap sudah tersimpan di Firebase._\n` +
                    `_Sedang mengirim foto bukti..._`;

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ chat_id: CHAT_ID, text: pesan, parse_mode: 'Markdown' })
        });

        // Kirim Foto Utama ke Telegram (Satu per satu)
        const docs = [
            {id:'ktp', c:'KTP'}, {id:'kk', c:'KK'}, {id:'penjamin', c:'PENJAMIN'}, 
            {id:'sim', c:'SIM'}, {id:'domisili', c:'DOMISILI'}, {id:'profil', c:'OJOL'}
        ];
        
        for(let d of docs) {
            let fi = document.getElementById(d.id);
            if(fi.files[0]) {
                let fd = new FormData();
                fd.append('chat_id', CHAT_ID);
                fd.append('photo', fi.files[0]);
                fd.append('caption', `${d.c} - ${document.getElementById('nama').value}`);
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
            }
        }
        
        // Kirim 1 sampel gaji ke Telegram (biar ga spam)
        if(gajiFiles.length > 0) {
            let fd = new FormData();
            fd.append('chat_id', CHAT_ID);
            fd.append('photo', gajiFiles[0]);
            fd.append('caption', `Sampel Pendapatan - ${document.getElementById('nama').value} (Sisa cek Firebase)`);
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
        }

        alert("âœ… SUKSES! Data tersimpan di Database & Terkirim ke Admin.");
        window.location.href = "index.html";

    } catch (err) {
        console.error(err);
        btn.disabled = false;
        load.innerText = "Gagal. Coba lagi.";
        alert("Error: " + err.message);
    }
});
</script>

</body>
</html>
