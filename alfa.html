<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulir Alva N3</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* STYLE CLEAN */
:root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; }
body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
.container { max-width: 550px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-top: 6px solid var(--primary); }
.header { text-align: center; margin-bottom: 30px; }
.header h2 { margin: 0; font-size: 26px; font-weight: 800; color: #1e293b; }
.section-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; margin: 30px 0 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
.form-group { margin-bottom: 15px; }
label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #334155; }
input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; box-sizing: border-box; background: #f8fafc; }
.upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.upload-box { border: 1px dashed #cbd5e1; background: #fff; border-radius: 10px; padding: 20px 10px; text-align: center; position: relative; }
.upload-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
.icon { font-size: 24px; display: block; margin-bottom: 8px; }
.lbl-up { font-size: 11px; font-weight: 700; display: block; color: #334155; }
.preview { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; border: 1px solid #e2e8f0; }
.btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 30px; }
.btn:disabled { background: #cbd5e1; cursor: not-allowed; }
#loading { display: none; text-align: center; margin-top: 20px; font-size: 13px; color: #2563eb; font-weight: 700; }
.back-link { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 12px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ALVA N3 (NEW)</h2>
        <p>Formulir Pengajuan Sewa Milik</p>
    </div>

    <form id="formAlfa">
        <div class="form-group"><label>Kode Referral</label><input type="text" id="referral" value="APRI" readonly style="background:#f1f5f9; cursor:not-allowed;"></div>

        <div class="section-label">DATA PRIBADI</div>
        <div class="form-group"><label>Nama Lengkap</label><input type="text" id="nama" required placeholder="Sesuai KTP"></div>
        <div class="form-group"><label>WhatsApp</label><input type="tel" id="wa" required placeholder="08xxxxxxxxxx"></div>
        <div class="form-group"><label>Email</label><input type="email" id="email" required placeholder="email@contoh.com"></div>
        <div class="form-group"><label>Alamat Domisili</label><textarea id="alamat" rows="2" placeholder="Alamat Lengkap..." required></textarea></div>

        <div class="section-label">DATA PENJAMIN (WAJIB SATU KK)</div>
        <div class="form-group"><label>Nama Penjamin</label><input type="text" id="penjaminNama" required></div>
        <div class="form-group"><label>No. WA Penjamin</label><input type="tel" id="penjaminNo" required></div>
        <div class="form-group"><label>Hubungan</label>
            <select id="penjaminHubungan" required>
                <option value="">-- Pilih Hubungan --</option>
                <option>Orang Tua</option>
                <option>Suami / Istri</option>
                <option>Saudara Kandung</option>
                <option>Anak</option>
            </select>
        </div>

        <div class="section-label">DOKUMEN PENDUKUNG</div>
        <div class="upload-grid">
            <div class="upload-box">
                <span class="icon">üì∑</span><span class="lbl-up">KTP ASLI</span>
                <input type="file" id="ktp" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_ktp">
            </div>
            <div class="upload-box">
                <span class="icon">üìÑ</span><span class="lbl-up">KARTU KELUARGA</span>
                <input type="file" id="kk" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_kk">
            </div>
            <div class="upload-box">
                <span class="icon">üí≥</span><span class="lbl-up">SIM C</span>
                <input type="file" id="sim" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_sim">
            </div>
            <div class="upload-box" style="border-color:#2563eb; background:#eff6ff">
                <span class="icon">üë•</span><span class="lbl-up" style="color:#2563eb">KTP PENJAMIN</span>
                <input type="file" id="foto_penjamin" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_foto_penjamin">
            </div>
            <div class="upload-box">
                <span class="icon">ü§≥</span><span class="lbl-up">SELFIE</span>
                <input type="file" id="selfie" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_selfie">
            </div>
            <div class="upload-box">
                <span class="icon">üì±</span><span class="lbl-up">PROFIL OJOL</span>
                <input type="file" id="profil" accept="image/*" required onchange="prev(this)"><img class="preview" id="show_profil">
            </div>
        </div>

        <div class="section-label">BUKTI PENDAPATAN</div>
        <div style="background:#fff5f5; padding:20px; border-radius:12px; border:1px dashed #fb7185;">
            <label style="color:#9f1239">Screenshot Gaji (Bisa Banyak)</label>
            <input type="file" id="gajiInput" multiple accept="image/*" style="width:100%; background:white">
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:15px" id="gajiBox"></div>
        </div>

        <div id="loading">‚è≥ Sedang Membuat PDF...<br>Mohon tunggu, jangan tutup halaman.</div>
        <button type="submit" class="btn" id="btnKirim">AJUKAN SEKARANG</button>
    </form>
    <a href="index.html" class="back-link">‚Üê Kembali ke Menu</a>
</div>

<script>
// CONFIG TELEGRAM
const BOT_TOKEN = "8235411301:AAE9bUwgg4eYS1M_e5_F30SAmNPgPs5zlF0";
const CHAT_ID = "1902240448";
const UNIT_NAME = "ALVA N3";

function prev(input) {
    if(input.files && input.files[0]) {
        let id = input.id;
        let imgId = id === 'foto_penjamin' ? 'show_foto_penjamin' : 'show_' + id;
        document.getElementById(imgId).src = URL.createObjectURL(input.files[0]);
        document.getElementById(imgId).style.display = "block";
    }
}

let gajiFiles = [];
document.getElementById('gajiInput').addEventListener('change', function(e) {
    const box = document.getElementById('gajiBox'); box.innerHTML = ""; 
    gajiFiles = Array.from(e.target.files).slice(0,12);
    gajiFiles.forEach(f => {
        const img = document.createElement('img'); img.src = URL.createObjectURL(f); 
        img.style.width="50px"; img.style.height="50px"; img.style.objectFit="cover"; img.style.borderRadius="4px";
        box.appendChild(img);
    });
});

const toBase64 = file => new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
});

document.getElementById('formAlfa').addEventListener('submit', async (e) => {
    e.preventDefault();
    if(gajiFiles.length === 0) { alert("Wajib upload bukti pendapatan."); return; }

    const btn = document.getElementById('btnKirim');
    const load = document.getElementById('loading');
    const namaUser = document.getElementById('nama').value;
    
    btn.disabled = true; load.style.display = "block";

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 1. HALAMAN BIODATA KHUSUS ALFA
        load.innerText = "Membuat PDF Halaman 1...";
        doc.setFontSize(18); doc.text(`PENGAJUAN: ${UNIT_NAME}`, 20, 20);
        doc.setFontSize(12);
        doc.text(`Referral: ${document.getElementById('referral').value}`, 20, 35);
        doc.text(`Nama: ${namaUser}`, 20, 45);
        doc.text(`WhatsApp: ${document.getElementById('wa').value}`, 20, 55);
        doc.text(`Email: ${document.getElementById('email').value}`, 20, 65);
        doc.text(`Domisili: ${document.getElementById('alamat').value}`, 20, 75);
        
        doc.text(`---------------------------------------`, 20, 90);
        doc.text(`DATA PENJAMIN (SATU KK):`, 20, 100);
        doc.text(`Nama: ${document.getElementById('penjaminNama').value}`, 20, 110);
        doc.text(`No WA: ${document.getElementById('penjaminNo').value}`, 20, 120);
        doc.text(`Hubungan: ${document.getElementById('penjaminHubungan').value}`, 20, 130);
        
        // FUNGSI PDF GAMBAR
        async function addImageToPdf(file, title) {
            if(file) {
                doc.addPage();
                doc.setFontSize(14); doc.text(title, 20, 20);
                const imgData = await toBase64(file);
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth() - 40;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                doc.addImage(imgData, 'JPEG', 20, 30, pdfWidth, pdfHeight);
            }
        }

        // 2. MASUKKAN FOTO-FOTO
        load.innerText = "Menyusun Dokumen...";
        await addImageToPdf(document.getElementById('ktp').files[0], "KTP ASLI");
        await addImageToPdf(document.getElementById('kk').files[0], "KARTU KELUARGA");
        await addImageToPdf(document.getElementById('sim').files[0], "SIM C");
        await addImageToPdf(document.getElementById('foto_penjamin').files[0], "KTP PENJAMIN"); // Foto Penjamin
        await addImageToPdf(document.getElementById('selfie').files[0], "FOTO SELFIE");
        await addImageToPdf(document.getElementById('profil').files[0], "PROFIL OJOL");

        // 3. FOTO GAJI
        let count = 1;
        for (let file of gajiFiles) {
            await addImageToPdf(file, `BUKTI PENDAPATAN #${count}`);
            count++;
        }

        const pdfBlob = doc.output('blob');

        // 4. KIRIM PDF KE TELEGRAM
        load.innerText = "Mengirim PDF ke Admin...";
        let formData = new FormData();
        formData.append('chat_id', CHAT_ID);
        formData.append('document', pdfBlob, `ALFA_${namaUser.replace(/\s+/g, '_')}.pdf`);
        formData.append('caption', `üìÑ Pengajuan Alfa N3: ${namaUser}\n(Data Penjamin ada di dalam PDF)`);

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, {
            method: 'POST', body: formData
        });

        alert("‚úÖ BERHASIL! File PDF terkirim.");
        window.location.href = "index.html";

    } catch(err) {
        console.error(err);
        btn.disabled = false;
        load.innerText = "Gagal. Coba lagi.";
        alert("Gagal proses PDF. Memori HP mungkin penuh.");
    }
});
</script>

</body>
</html>
