<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrasi Sewa Milik</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0056b3; --bg: #f5f7fa; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .header h1 { text-align: center; color: var(--primary); margin-bottom: 5px; font-size: 24px; text-transform: uppercase; }
        .header p { text-align: center; font-size: 12px; color: #666; margin-bottom: 25px; }

        .form-section { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .section-label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; }
        input[type="text"], input[type="number"], input[type="email"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; font-size: 13px; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .checkbox-wrap { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 5px; }
        .app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; background: #fafafa; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .app-grid label { display: flex; align-items: center; gap: 8px; font-weight: normal; margin: 0; cursor: pointer; }

        /* GRID UPLOAD */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .upload-grid { grid-template-columns: 1fr; } }

        .upload-card { border: 2px dashed #ddd; border-radius: 8px; padding: 10px; background: #fafafa; position: relative; }
        .upload-card.optional { border-color: #aed581; background: #f1f8e9; } /* Beda warna dikit buat yg opsional */
        .upload-label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px; }
        .upload-card input[type="file"] { font-size: 11px; width: 100%; }
        
        .status-badge {
            position: absolute; top: 10px; right: 10px; font-size: 10px; font-weight: bold; 
            padding: 3px 6px; border-radius: 4px; display: none; color: white;
        }
        .st-loading { background: #ff9800; display: block; animation: pulse 1s infinite; }
        .st-success { background: var(--success); display: block; }
        .st-error { background: var(--danger); display: block; }
        
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.5;} 100% {opacity:1;} }

        .btn-submit { background: var(--primary); color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-submit:disabled { background: #999; cursor: not-allowed; }
        .btn-submit:hover:not(:disabled) { background: #004494; }

        #logArea { font-size: 11px; color: #666; text-align: center; margin-top: 10px; font-weight: bold; height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>REGISTRASI SEWA MILIK</h1>
        <p>Isi formulir dengan lengkap dan upload dokumen yang diminta.</p>
    </div>

    <form id="sewamilikForm">
        
        <div class="form-section">
            <span class="section-label">1. Pilihan Kendaraan</span>
            <div class="form-group">
                <label>Pilih Tipe Motor</label>
                <select id="pilihanMotor" required onchange="cekMotor()">
                    <option value="">-- Pilih Motor --</option>
                    <option value="Polytron 350">Polytron 350</option>
                    <option value="Maka Cavalry">Maka Cavalry</option>
                    <option value="Alfa N3">Alfa N3</option>
                </select>
            </div>

            <div class="form-group" id="grupReferral" style="display: none;">
                <label style="color: var(--primary);">Kode Referral</label>
                <input type="text" id="referral" readonly style="background:#e9ecef; color:#555; font-weight:bold;">
                <small style="color:#666; font-size:11px;">*Otomatis terisi khusus pengajuan Alfa N3</small>
            </div>
        </div>

        <div class="form-section">
            <span class="section-label">2. Identitas Diri</span>
            <div class="form-group"><label>Nomor Induk Kependudukan (NIK)</label><input type="number" id="nik" required placeholder="16 digit NIK"></div>
            <div class="form-group"><label>Nama Lengkap (Sesuai KTP)</label><input type="text" id="nama" required></div>
            <div class="form-group"><label>Nomor WhatsApp</label><input type="number" id="wa" required placeholder="08xxxxxxxxxx"></div>
            <div class="form-group"><label>Email Aktif</label><input type="email" id="email" required></div>
            <div class="form-group"><label>Alamat KTP</label><textarea id="alamatKtp" rows="2" required placeholder="Sesuai yang tertulis di KTP"></textarea></div>
            <div class="form-group">
                <label>Alamat Domisili (Tempat Tinggal Sekarang)</label>
                <div class="checkbox-wrap"><input type="checkbox" id="checkSama" onchange="copyAlamat()"> Sama dengan KTP</div>
                <textarea id="alamatDomisili" rows="2" required placeholder="Tulis alamat domisili lengkap"></textarea>
            </div>
        </div>

        <div class="form-section">
            <span class="section-label">3. Kontak Penjamin</span>
            <div class="form-group"><label>Nama Penjamin</label><input type="text" id="penjaminNama" required></div>
            <div class="form-group"><label>Nomor WhatsApp Penjamin</label><input type="number" id="penjaminWa" required></div>
            <div class="form-group"><label>Hubungan dengan Pemohon</label>
                <select id="penjaminHubungan" required>
                    <option value="">-- Pilih Hubungan --</option>
                    <option value="Suami/Istri">Suami / Istri</option>
                    <option value="Orang Tua">Orang Tua (Ayah/Ibu)</option>
                    <option value="Kakak/Adik">Kakak / Adik</option>
                    <option value="Keluarga Lainnya">Keluarga Lainnya</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <span class="section-label">4. Data Pekerjaan & Upload</span>
            
            <div class="form-group">
                <label>Aplikasi Ojol Yang Digunakan <span style="font-weight:normal; color:#666;">(Bisa pilih lebih dari 1)</span></label>
                <div class="app-grid">
                    <label><input type="checkbox" name="aplikasi" value="Gojek"> Gojek</label>
                    <label><input type="checkbox" name="aplikasi" value="Grab"> Grab</label>
                    <label><input type="checkbox" name="aplikasi" value="ShopeeFood"> Shopee Food</label>
                    <label><input type="checkbox" name="aplikasi" value="Maxim"> Maxim</label>
                    <label><input type="checkbox" name="aplikasi" value="Lalamove"> Lalamove</label>
                    <label><input type="checkbox" name="aplikasi" value="Lainnya"> Lainnya</label>
                </div>
            </div>

            <p style="font-size: 11px; color: #666; margin-bottom: 10px;">*Untuk bukti penghasilan, wajib isi Bulan 1 s/d 3. Bulan 4 s/d 8 opsional (boleh diisi jika ada).</p>
            
            <div class="upload-grid" id="uploadContainer">
                </div>
        </div>

        <button type="submit" class="btn-submit" id="btnKirim">KIRIM PENGAJUAN</button>
        <div id="logArea"></div>
    </form>
</div>

<script>
    // --- API KEYS ---
    const IMGBB_API_KEY = "20a1c8c9ff8aac31f3f3c0b2968fdb4f";
    
    // --- FIREBASE FIRESTORE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
      authDomain: "rtomaka-e67b5.firebaseapp.com",
      projectId: "rtomaka-e67b5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- SETUP FILE UPLOAD DENGAN 8 SLOT PENDAPATAN ---
    const files = [
        {id: 'selfie', label: '1. Foto Selfie', req: true},
        {id: 'ktp', label: '2. Foto KTP Asli', req: true},
        {id: 'sim', label: '3. Foto SIM C', req: true},
        {id: 'kk', label: '4. Kartu Keluarga', req: true},
        {id: 'ojol_profile', label: '5. Profil Aplikasi Ojol', req: true},
        {id: 'token_listrik', label: '6. Bukti Token Listrik', req: true},
        {id: 'ktp_penjamin', label: '7. KTP Penjamin', req: true},
        {id: 'foto_rumah', label: '8. Rumah Tampak Depan', req: true},
        
        // BUKTI PENDAPATAN (1-3 WAJIB, 4-8 OPSIONAL)
        {id: 'pendapatan1', label: '9a. Penghasilan (Bln 1)', req: true},
        {id: 'pendapatan2', label: '9b. Penghasilan (Bln 2)', req: true},
        {id: 'pendapatan3', label: '9c. Penghasilan (Bln 3)', req: true},
        {id: 'pendapatan4', label: '9d. Penghasilan (Bln 4) <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false},
        {id: 'pendapatan5', label: '9e. Penghasilan (Bln 5) <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false},
        {id: 'pendapatan6', label: '9f. Penghasilan (Bln 6) <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false},
        {id: 'pendapatan7', label: '9g. Penghasilan (Bln 7) <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false},
        {id: 'pendapatan8', label: '9h. Penghasilan (Bln 8) <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false},
        
        {id: 'domisili', label: '10. Surat Domisili <br><small style="color:#28a745;font-weight:normal">(Opsional)</small>', req: false}
    ];

    const uploadContainer = document.getElementById('uploadContainer');
    files.forEach(f => {
        const reqAttr = f.req ? 'required' : '';
        const optClass = f.req ? '' : 'optional'; // Biar kotak opsional warnanya beda dikit
        uploadContainer.innerHTML += `
            <div class="upload-card ${optClass}">
                <div id="badge_${f.id}" class="status-badge"></div>
                <span class="upload-label">${f.label}</span>
                <input type="file" id="${f.id}" accept="image/*" ${reqAttr}>
            </div>
        `;
    });

    // --- FUNGSI DINAMIS PILIHAN MOTOR ---
    function cekMotor() {
        const motor = document.getElementById('pilihanMotor').value;
        const grupRef = document.getElementById('grupReferral');
        const inputRef = document.getElementById('referral');

        if (motor === 'Alfa N3') {
            grupRef.style.display = 'block'; 
            inputRef.value = 'Apri';         
        } else {
            grupRef.style.display = 'none';  
            inputRef.value = '';             
        }
    }

    // --- FUNGSI PENDUKUNG ---
    function copyAlamat() {
        const c = document.getElementById('checkSama'), d = document.getElementById('alamatDomisili'), k = document.getElementById('alamatKtp');
        if (c.checked) { d.value = k.value; d.readOnly = true; d.style.background = "#eee"; } 
        else { d.value = ""; d.readOnly = false; d.style.background = "white"; }
    }

    function setStatus(id, state, text) {
        const badge = document.getElementById(`badge_${id}`);
        badge.className = `status-badge st-${state}`;
        badge.innerText = text;
    }

    function log(text) { document.getElementById('logArea').innerText = text; }

    // KOMPRES GAMBAR IMGBB
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 800; 
                    const scale = MAX / img.width;
                    canvas.width = MAX;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => { 
                        let newFile = new File([blob], file.name, { type: "image/jpeg", lastModified: Date.now() });
                        resolve(newFile);
                    }, 'image/jpeg', 0.7); 
                }
            }
        });
    }

    // --- PROSES SUBMIT UTAMA ---
    document.getElementById('sewamilikForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnKirim');
        
        // Cek file wajib
        let isFileLengkap = true;
        files.forEach(f => {
            if (f.req && document.getElementById(f.id).files.length === 0) {
                isFileLengkap = false;
                document.getElementById(f.id).style.border = "1px solid red";
            } else {
                document.getElementById(f.id).style.border = "none";
            }
        });

        // Ambil Data Checkbox Aplikasi
        let appTerpilih = [];
        document.querySelectorAll('input[name="aplikasi"]:checked').forEach(cb => {
            appTerpilih.push(cb.value);
        });

        if (appTerpilih.length === 0) {
            alert("Harap pilih minimal 1 Aplikasi Ojol yang digunakan!");
            return;
        }

        if (!isFileLengkap) { alert("Masih ada foto wajib yang belum diupload!"); return; }

        btn.disabled = true;
        log("Mempersiapkan data...");

        try {
            let uploadedUrls = {};
            let totalToUpload = 0;
            let currentUploaded = 0;

            files.forEach(f => { if(document.getElementById(f.id).files.length > 0) totalToUpload++; });

            // 1. UPLOAD KE IMGBB
            for (let f of files) {
                const fileInput = document.getElementById(f.id);
                if (fileInput.files.length > 0) {
                    setStatus(f.id, 'loading', 'Up...');
                    btn.innerText = `MENGUPLOAD FOTO (${currentUploaded + 1}/${totalToUpload})`;
                    
                    const smallFile = await compressImage(fileInput.files[0]);
                    const formData = new FormData();
                    formData.append("image", smallFile);

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if(result.success) {
                        uploadedUrls[f.id + '_url'] = result.data.url; 
                        setStatus(f.id, 'success', 'OK');
                        currentUploaded++;
                    } else {
                        setStatus(f.id, 'error', 'Gagal');
                        throw new Error(`Gagal upload ${f.label}`);
                    }
                }
            }

            // 2. SIMPAN DATA KE FIREBASE
            btn.innerText = "MENYIMPAN DATA KE SISTEM...";
            log("Memasukkan biodata ke database...");

            const finalData = {
                // Info Pendaftaran
                motor_pilihan: document.getElementById('pilihanMotor').value,
                referral: document.getElementById('referral').value,
                
                // Identitas Diri
                nik: document.getElementById('nik').value,
                nama: document.getElementById('nama').value,
                wa: document.getElementById('wa').value,
                email: document.getElementById('email').value,
                alamatKtp: document.getElementById('alamatKtp').value,
                alamatDomisili: document.getElementById('alamatDomisili').value,

                // Kontak Penjamin
                penjamin_nama: document.getElementById('penjaminNama').value,
                penjamin_wa: document.getElementById('penjaminWa').value,
                penjamin_hubungan: document.getElementById('penjaminHubungan').value,
                
                // Aplikasi Ojol Array
                aplikasi_ojol: appTerpilih.join(", "),

                // Alur Status
                status_pengajuan: "1_Menunggu_Admin", 
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Link Foto (Dinamis, yang nggak diupload nggak bakal masuk ke DB)
                ...uploadedUrls 
            };

            await db.collection("gadingfc22").add(finalData);

            alert("SUKSES! Data pengajuan Anda sudah masuk ke sistem.");
            window.location.reload();

        } catch (error) {
            console.error(error);
            alert("Terjadi kesalahan: " + error.message + "\nSilakan coba klik tombol kirim lagi.");
            btn.disabled = false;
            btn.innerText = "COBA KIRIM LAGI";
            log("Gagal, silakan coba lagi.");
        }
    });
</script>
</body>
</html>
